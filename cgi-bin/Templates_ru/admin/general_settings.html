<html>
<head>
	{NEED_PERMISSION|admin_general_settings}
	<base href="{GET|$settings.urls.htmlurl}">
	<link rel="stylesheet" href="{GET|$runtime.style}.css">

	<script language="JavaScript">
		var info = '{DOFILTER|escape_js}{INCLUDE|admin/general_settings_info}{ENDDO}';

		var old_settings = new Array();
		{FOREACH|$entry|$settings}
			old_settings['settings.{GET_JS|$entry.name}'] = '{GET_JS|$entry.value}';
		{ENDFOR}
		
		function toHTML(str)
		{
			var replacements = new Array();
			replacements['&'] = '&amp;';
			replacements['"'] = '&quot;';
			replacements['<'] = '&lt;';
			replacements['>'] = '&gt;';

			// escape relevant HTML symbols
			// must do it this way, Opera doesn't know RegExp
			var pos;
			var ret = "";
			str = str.replace(/\n/g,'');
			str = str.replace(/\r/g,'');
			while ((pos = str.search(/([&"<>])/)) != -1)
			{
				ret += str.substr(0, pos) + replacements[str.substr(pos,1)];
				str = str.substring(pos+1, str.length);
			}
			ret += str;
			return ret;
		}

		function showInfo(text)
		{
			var wnd = top.opener.openCenteredWindow('','general_settings_info',400,100);
			wnd.document.open('text/html','replace');
			wnd.document.write(info.replace(/\%\%text\%\%/g,text));
			wnd.document.close();
		}

		function checkInput(form)
		{
			form['settings.chatname'].value = toHTML(form['settings.chatname'].value);
			form['settings.webmaster_email'].value = form['settings.webmaster_email'].value.replace(/[<>"&]/g,'');
		
			form['settings.alive_test_rate_push'].value = parseInt(form['settings.alive_test_rate_push'].value) || 2;
			if (form['settings.alive_test_rate_push'].value < 2)
				form['settings.alive_test_rate_push'].value = 2;

			form['settings.alive_test_rate_pull'].value = parseInt(form['settings.alive_test_rate_pull'].value) || 2;
			if (form['settings.alive_test_rate_pull'].value < 2)
				form['settings.alive_test_rate_pull'].value = 2;

			form['settings.autokick_test_rate'].value = parseInt(form['settings.autokick_test_rate'].value) || 0;
			if (form['settings.autokick_test_rate'].value < 0)
				form['settings.autokick_test_rate'].value = 0;

			form['settings.send_blocking_timeout'].value = parseInt(form['settings.send_blocking_timeout'].value) || 2;
			if (form['settings.send_blocking_timeout'].value < 2)
				form['settings.send_blocking_timeout'].value = 2;

			form['settings.logoutreason_keeping_time'].value = parseInt(form['settings.logoutreason_keeping_time'].value) || 0;
			if (form['settings.logoutreason_keeping_time'].value < 0)
				form['settings.logoutreason_keeping_time'].value = 0;

			form['settings.pwseed'].value = form['settings.pwseed'].value.replace(/[<>"&]/g,'');
			while (form['settings.pwseed'].value.length<2)
				form['settings.pwseed'].value += 'a';
				
			window.cancelled = 1;
		}

		function cancel(unload)
		{
			if (window.cancelled)
				return;

			var elements = document.inputForm.elements;
			var changed = false;
			for (var i=0;!changed && i<elements.length;i++)
			{
				if (elements[i].name.match(/^settings\.(.*)/))
				{
					if (elements[i].type.match(/select/))
						changed = (elements[i].options[elements[i].selectedIndex].value != old_settings[elements[i].name]);
					else
						changed = (elements[i].value != old_settings[elements[i].name]);
				}
			}
			
			if (changed)
			{
				var msg = 'Вы действительно хотите отменить все изменения?';
				if (unload)
					return msg;
				else if (!confirm(msg))
					return;
			}

			window.cancelled = 1;
				
			parent.writeMenu();
		}
	</script>
</head>

<body onload="parent.autosize(window)" onbeforeunload="return cancel(1)">

<table border=0 width="100%" cellspacing=0 cellpadding=0 class="outer"><tr><td>
<table border=0 width="100%" cellspacing=1 cellpadding=3>

	<tr>
		<th>Общие установки</th>
	</tr>
	<form name="inputForm" method="post" action="{GET|$runtime.chaturl}" onsubmit="checkInput(this)">
	{GET|$runtime.hiddenfields}
	<input type=hidden name=action value="admin_general_settings">
	<tr class="row2">
		<td align=right><input type=submit class="plain" class="netscape-dummy" value="Записать"> &nbsp; <input type=button class="plain" class="netscape-dummy" value="Отменить" onclick="cancel();return false"></td>
	</tr>
	<tr class="row2">
		<td><table border=0 cellpadding=5 cellpadding=0 width="100%">
		<tr>
			<td>{IMAGE|error}</td>
			<td width="100%">Многие из этих установок могут создать существенные проблемы. Меняйте что-нибудь только тогда, когда вы точно знаете, что вы делаете! Нажмите на знак вопроса, чтобы получить более подробное описание к данной установке.</td>
		</tr>
		</table></td>
	</tr>
	<tr class="row2">
		<td><table border=0 cellspacing=5 cellpadding=0 width="100%">
		<tr>
			<td><a href="javascript:void(0)" onclick="showInfo('Название Вашего чата, которое будет показываться в системных сообщениях и как заголовок многих страниц.');return false">{IMAGE|question}</a></td>
			<td>Название чата:</td>
			<td><input type=text name="settings.chatname" maxlength=255 style="width:100%" value="{GET|$settings.chatname}"></td>
		</tr>
		<tr>
			<td><a href="javascript:void(0)" onclick="showInfo('Адрес, который будет вноситься как отправитель в письма, отсылаемые чатом.');return false">{IMAGE|question}</a></td>
			<td>Адрес e-mail владельца чата:</td>
			<td><input type=text name="settings.webmaster_email" maxlength=255 style="width:100%" value="{GET|$settings.webmaster_email}"></td>
		</tr>
		<tr>
			<td><a href="javascript:void(0)" onclick="showInfo('Браузер регулярно посылает серверу сообщения, которые показывают, что пользователь ещё в чате. Если какое-то время эти сообщения не поступают, то это признак того, что пользователь закрыл браузер не выйдя из чата. Здесь устанавливается период времени для нормального режима, после которого пользователь автоматически выкидывается из чата, если от него не было получено никаких сообщений.');return false">{IMAGE|question}</a></td>
			<td>Проверка соединения в стандартном режиме каждые:</td>
			<td><input type=text name="settings.alive_test_rate_push" length=5 maxlength=4 value="{GET|$settings.alive_test_rate_push}"> секунд</td>
		</tr>
		<tr>
			<td><a href="javascript:void(0)" onclick="showInfo('Браузер регулярно посылает серверу сообщения, которые показывают, что пользователь ещё в чате. Если какое-то время эти сообщения не поступают, то это признак того, что пользователь закрыл браузер не выйдя из чата. Здесь устанавливается период времени для безопасного режима, после которого пользователь автоматически выкидывается из чата, если от него не было получено никаких сообщений.');return false">{IMAGE|question}</a></td>
			<td>Проверка соединения в безопасном режиме каждые:</td>
			<td><input type=text name="settings.alive_test_rate_pull" length=5 maxlength=4 value="{GET|$settings.alive_test_rate_pull}"> секунд</td>
		</tr>
		<tr>
			<td><a href="javascript:void(0)" onclick="showInfo('Время, после которого пользователи выкидываются из чата (с соответствующим сообщением), если они ничего не говорят. Чтобы отключить автоматическое выкидывание, надо установить здесь 0 секунд.');return false">{IMAGE|question}</a></td>
			<td>Выкидывать молчаливых пользователей после:</td>
			<td><input type=text name="settings.autokick_test_rate" length=5 maxlength=4 value="{GET|$settings.autokick_test_rate}"> секунд</td>
		</tr>
		<tr>
			<td><a href="javascript:void(0)" onclick="showInfo('Когда пользователь нажимает на &quot;Отослать&quot;, все дальнейшие тексты не посылаются, а лишь записываются в буфер до тех пор, пока не будет принято подтверждение с сервера. Если подтверждение не будет принято в течении этого периода времени, то передача текста на сервер считается неудачной и повторяется.');return false">{IMAGE|question}</a></td>
			<td>Прерывать попытки послать текст после:</td>
			<td><input type=text name="settings.send_blocking_timeout" length=5 maxlength=4 value="{GET|$settings.send_blocking_timeout}"> секунд</td>
		</tr>
		<tr>
			<td><a href="javascript:void(0)" onclick="showInfo('Когда пользователь по какой-то причине выкидывается из чата, то эта причина записывается в файл, из которого она извлекается страницей выхода из чата. Если пользователь не попал на страницу выхода в течении этого периода времени, то причина его выхода может быть удалена из файла.');return false">{IMAGE|question}</a></td>
			<td>Хранить причину выхода из чата:</td>
			<td><input type=text name="settings.logoutreason_keeping_time" length=5 maxlength=4 value="{GET|$settings.logoutreason_keeping_time}"> секунд</td>
		</tr>
		<tr>
			<td><a href="javascript:void(0)" onclick="showInfo('Важно в основном при использовании mod_perl. Под mod_perl шаблоны кешируются в памяти, без mod_perl это тоже в некоторых случаях делается. Если проверка включена, то перед каждым использованием шаблона будет проверяться, не изменился ли он на диске и не надо ли его перезагрузить. Если изменения шаблонов в скором будущем не предвидятся, то проверку можно отключить в пользу скорости выполнения.');return false">{IMAGE|question}</a></td>
			<td>Проверять шаблоны на изменения:</td>
			<td>
				<select name="settings.check_template_modification" style="width:100%">
					<option value=1 {IIF|$settings.check_template_modification|selected}>да
					<option value=0 {IIF|!$settings.check_template_modification|selected}>нет
				</select>
			</td>
		</tr>
		<tr>
			<td><a href="javascript:void(0)" onclick="showInfo('Важно только при использовании mod_perl. Под mod_perl плугины кешируются в памяти. Если проверка включена, то перед каждым использованием плугина будет проверяться, не изменился ли он на диске и не надо ли его перезагрузить. Если изменения плугинов в скором будущем не предвидятся, то проверку можно отключить в пользу скорости выполнения.');return false">{IMAGE|question}</a></td>
			<td>Проверять плугины на изменения:</td>
			<td>
				<select name="settings.check_module_modification" style="width:100%">
					<option value=1 {IIF|$settings.check_module_modification|selected}>да
					<option value=0 {IIF|!$settings.check_module_modification|selected}>нет
				</select>
			</td>
		</tr>
		<tr>
			<td><a href="javascript:void(0)" onclick="showInfo('Чат может убирать лишние строки и пробелы из HTML-страниц, которые он создаёт. Экономия трафика при этом роли не играет, эта функция существует разве что из эстетических причин.');return false">{IMAGE|question}</a></td>
			<td>Убирать пустые строки из HTML-страниц:</td>
			<td>
				<select name="settings.compress_output" style="width:100%">
					<option value=1 {IIF|$settings.compress_output|selected}>да
					<option value=0 {IIF|!$settings.compress_output|selected}>нет
				</select>
			</td>
		</tr>
		<tr>
			<td><a href="javascript:void(0)" onclick="showInfo('Метод, которым предотвращается одновременный доступ к файлам. Обычно используется функция flock(). Блокировки с помощью модуля Perl Win32::Semaphore предназначены для Windows 95/98/ME, где этой функции нет. Никогда не следует полностью отключать блокировки, это может привести к потерям данных.');return false">{IMAGE|question}</a></td>
			<td>Метод блокировки файлов:</td>
			<td>
				<select name="settings.lock_type" style="width:100%">
					<option value=0 {IIF|$settings.lock_type == 0|selected}>никакого
					<option value=1 {IIF|$settings.lock_type == 1|selected}>flock
					<option value=2 {IIF|$settings.lock_type == 2|selected}>Win32::Semaphore
				</select>
			</td>
		</tr>
		<tr>
			<td><a href="javascript:void(0)" onclick="showInfo('Обычно для шифрования паролей используется функция операционной системы crypt(). Эта функция отсутствует в некоторых старых версиях Perl для Windows, поэтому GTChat содержит встроенную библиотеку для замены. Шифрование этой библиотекой очень медленно, поэтому её следует использовать только в тех случаях, когда иначе нельзя.');return false">{IMAGE|question}</a></td>
			<td>Использовать встроенную функцию шифрования:</td>
			<td>
				<select name="settings.use_internal_crypt" style="width:100%">
					<option value=1 {IIF|$settings.use_internal_crypt|selected}>да
					<option value=0 {IIF|!$settings.use_internal_crypt|selected}>нет
				</select>
			</td>
		</tr>
		<tr>
			<td><a href="javascript:void(0)" onclick="showInfo('Параметр salt функции crypt(), который используется для шифрования паролей.');return false">{IMAGE|question}</a></td>
			<td>Salt для шифрования:</td>
			<td><input type=text name="settings.pwseed" maxlength=2 style="width:100%" value="{GET|$settings.pwseed}"></td>
		</tr>
		</table></td>
	</tr>
	<tr class="row2">
		<td align=right><input type=submit class="plain" class="netscape-dummy" value="Записать"> &nbsp; <input type=button class="plain" class="netscape-dummy" value="Отменить" onclick="cancel();return false"></td>
	</tr>
	</form>
</table>
</td></tr></table>

</body>
</html> 
